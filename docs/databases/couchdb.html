<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
			<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

		gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <title>Kitura CouchDB</title>
    <link rel="icon" type="image/png" href="../../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../../assets/favicon-16x16.png" sizes="16x16" />
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/dist/docs.css">
  </head>
<body>
  <section class="docs-grid-container">
    <aside id="sidebar" class="docs-item-1 docs-sidebar">
      <h1 class="docs-title"><a href="/index.html">KITURA <span class="blue-text">DOCS</span></a></h1>
      <div class="underline-title"></div>
      <ul class="sidebar-list">
        <li class="sidebar-item collapsible">Getting Started</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../getting-started/installation-mac.html">Installation for macOS</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/installation-linux.html">Installation for Linux</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/create-server.html">Create a server</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/style-guide.html">Style Guide</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/update-package.html">Adding Packages</a></li>
        </ul>
        <li class="sidebar-item collapsible">Logging</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../logging/logging.html">What is Logging?</a></li>
          <li class="nested-sidebar-item"><a href="../logging/helium-logger.html">Helium Logger</a></li>
        </ul>
        <li class="sidebar-item collapsible">Routing</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../routing/routing.html">What is routing?</a></li>
          <li class="nested-sidebar-item"><a href="../routing/codable-routing.html">Codable routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/raw-routing.html">Raw routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/open-api.html">OpenAPI</a></li>
        </ul>
        <li class="sidebar-item collapsible">Databases</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../databases/databases.html">What are Databases?</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery-orm.html">SQL: ORM</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery.html">SQL: Kuery</a></li>
          <li class="nested-sidebar-item active"><a href="../databases/couchdb.html">NoSQL: CouchDB</a></li>
        </ul>
        <li class="sidebar-item collapsible">Sessions</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../sessions/sessions.html">What are Sessions?</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/kitura-session.html">Kitura Session</a></li>
        </ul>
        <li class="sidebar-item collapsible">Authentication</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../authentication/authentication.html">What is Authentication?</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/typesafe-auth.html">Type-Safe Credentials</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/jwt-auth.html">JSON Web Tokens</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/fb-google-oauth2.html">OAuth 2.0 with Facebook/Google</a></li>
        </ul>
        <li class="sidebar-item collapsible">Web Application</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../templating/templating.html">What is templating?</a></li>
          <li class="nested-sidebar-item"><a href="../templating/stencil.html">Stencil</a></li>
          <li class="nested-sidebar-item"><a href="../templating/markdown.html">Markdown</a></li>
        </ul>
        <li class="sidebar-item collapsible">Deploying</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../deploying/monitoring.html">Monitoring</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/ssl.html">Enabling SSL/TLS</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/docker.html">Docker</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/kubernetes.html">Kubernetes</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/cloud-foundry.html">Cloud Foundry</a></li>
        </ul>
      </ul>
    </aside>
    <div id="burgerIcon" class="burger-icon" onclick="showSidebar()">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
    <div class="docs-item-2 search-container">
      <!-- <input class="docs-search" type="text" name="searchInput" placeholder="Search documentation..."> -->
      <div id="beta" class="temp-beta">
        <h4>Currently in Beta - <a href="../../old-learn.html">View old docs</a></h4>
      </div>
    </div>
    <nav class="docs-item-3 docs-nav">
      <button id="api-button" class="apiref-button" type="button" name="button" onclick="window.open('https://ibm-swift.github.io/Kitura/')">API Reference</button>
      <a class="nav-item" target="_blank" href="http://slack.kitura.io/">Need help?</a>
      <a class="nav-item" target="_blank" href="https://github.com/IBM-Swift/kitura.io/issues">Found an issue?</a>
    </nav>
    <div id="doc-container" class="docs-item-4 docs-window">
      <main>
        <h1 class="heading-1">Kitura CouchDB</h1>
        <p><a target="_blank" href="http://couchdb.apache.org/">CouchDB</a> is a NoSQL (or non-relational) database which takes a document-oriented approach to data storage.</p>
        <p><a target="_blank" href="https://github.com/IBM-Swift/Kitura-CouchDB">Kitura-CouchDB</a> is a pure Swift client which allows Kitura applications to interact with a CouchDB or <a target="_blank" href="https://www.ibm.com/uk-en/cloud/cloudant">Cloudant</a> database.</p>
        <p>In this guide we’ll demonstrate how to create a CouchDB database, define a CouchDB document, save the document to the database and finally retrieve the document from the database.</p>
        <div class="underline"></div>
        <h2 class="heading-2">Prerequisites</h2>
        <ul class="plain-list">
          <li><a onclick="setActiveSidebarElementForParent('create-server')" href="../getting-started/create-server.html#">Kitura Server:</a> Learn how to create one in our getting started guide.</li>
          <li><a onclick="setActiveSidebarElementForParent('create-server')" href="../routing/routing.html#">Routing:</a> Learn how to add routes in our routing guides.</li>
          <li><a onclick="localStorage.setItem('package', 'Kitura-CouchDB'); setActiveSidebarElementForParent('couchdb')" href="../getting-started/update-package.html#">Update Dependencies:</a> Kitura CouchDB needs adding to the `Package.swift` file.</li>
        </ul>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 1:</span> Install CouchDB and create a database</h2>
        <p>Before we can use CouchDB within our server we first need to <a target="_blank" href="http://couchdb.apache.org/#download">download and install CouchDB</a>.</p>
        <p>Next, set up an admin username and password in CouchDB.</p>
        <p>It is important to remember the credentials used here as we will need them to interact with the database from our server.</p>
        <p>Next, create a database, in this example we're using the name `bookstore`.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 2:</span> Add Kitura-CouchDB to the project</h2>
        <p>Import CouchDB into our project:</p>
        <pre><code class="language-swift">import CouchDB</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 3:</span> Define the CouchDB routes</h2>
        <p>Open your `Application.swift` file:</p>
        <pre><code>open Sources/Application/Application.swift</code></pre>
        <p> Inside the `postInit()` function add: </p>
        <pre><code class="language-swift">initializeCouchRoutes(app: self)</pre></code>
        <p>Create a new file, called `CouchRoutes.swift`:</p>
        <pre><code>touch Sources/Application/Routes/CouchRoutes.swift</code></pre>
        <p>Open your `CouchRoutes.swift` file:</p>
        <pre><code>open Sources/Application/Routes/CouchRoutes.swift</code></pre>
        <p>Inside this file we are going to create two routes. The first route will save a document into the bookstore database and the second will retrieve all of the saved documents from the database.</p>
        <pre><code class="language-swift">import KituraContracts
import CouchDB
import LoggerAPI

func initializeCouchRoutes(app: App) {
    // Connect to database here
    app.router.post("/couch", handler: app.couchSaveHandler)
    app.router.get("/couch", handler: app.couchFindAllHandler)
}
extension App {
    func couchSaveHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
        // Save book here
    }

    func couchFindAllHandler(completion: ([Book]?, RequestError?) -> Void) {
        // Get all books here
    }
}</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 4:</span> Connect to CouchDB database</h2>
        <p>Inside our App extension, we will define our connection properties for CouchDB, substituting in the credentials we defined earlier for the admin username and password:</p>
        <pre><code class="language-swift">static let properties = ConnectionProperties(
        host: "127.0.0.1",              // http address
        port: 5984,                     // http port
        secured: false,                 // https or http
        username: "&lt;CouchDB-username&gt;", // admin username
        password: "&lt;CouchDB-password&gt;"  // admin password
)</code></pre>
        <p>Now we can use these connection properties to create our CouchDB client:</p>
        <pre><code class="language-swift">static let couchDBClient = CouchDBClient(connectionProperties: properties)</code></pre>
        <p>The `CouchDBClient` represents a connection to a CouchDB server. It is initialized with your `ConnectionProperties` and handles the creation, retrieval and deletion of CouchDB databases.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 5:</span> Define a Document</h2>

        <p>CouchDB is a NoSQL database for storing documents. A `Document` is any structure that can be represented as JSON and contains `_id` and `_rev` fields.
        <ul><li>The `id` field is the unique identifier for the document.</li>
        <li>The `_rev` field is the revision of the document. It is returned when you make requests and is used to prevent conflicts from multiple users updating the same document.</li></ul></p>

        <p>To define a CouchDB document, all we need to do is create a Swift object and make it conform to the `Document` protocol.</p>

        <p>Create a new file, called `BookDocument.swift`:</p>
        <pre><code>touch Sources/Application/Models/BookDocument.swift</code></pre>
        <p>Open your `BookDocument.swift` file:</p>
        <pre><code>open Sources/Application/Models/BookDocument.swift</code></pre>
        <p>Inside this file, define your `BookDocument` class:</p>
        <pre><code class="language-swift">import CouchDB

struct BookDocument: Document {
    let _id: String?
    var _rev: String?
    var value: Book
}</code></pre>
    <h2 class="heading-2"><span class="blue-text">Step 6:</span> Save our document to the database</h2>
        <p>To save data to our CouchDB database we first need some data to save, this data can be provided via the POST route which we created earlier.</p>
        <p>We will modify the route handler, `couchSaveHandler`, which we defined earlier so that it can store data in our database:</p>
        <p>First we need to connect to our `bookstore` database.</p>
        <p>The `CouchDBClient` represents a connection to the CouchDB server. We use can the `CouchDBClient.retrieveDB()` method passing in our database name to connect to our existing CouchDB database.</p>
        <p>Next we create a CouchDB document called `bookDocument` using the book which is passed into our POST route.</p>
        <p>Now we are going to save our book document to the database. We will use the CouchDB `Database` class to make an HTTP request to our database. This class can make CRUD (Create, Retrieve, Update, Delete) requests for our CouchDB `Document`. In this case we will use `create` to save our book document. If the call succeeds we then return the book as JSON, otherwise we return an error.</p>
        <pre><code class="language-swift">func couchSaveHandler(book: Book, completion: @escaping (Book?, RequestError?) -> Void) {
    App.couchDBClient.retrieveDB("bookstore") { (database, error) in
        guard let database = database  else {
            return completion(nil, .internalServerError)
        }
        let bookDocument = BookDocument(_id: String(book.id), _rev: nil, value: book)
        database.create(bookDocument) { (response, error) in
            if let error = error {
                Log.error(error.localizedDescription)
                return completion(nil, RequestError(httpCode: error.statusCode))
            }
            guard response != nil else {
                Log.error("Unknown CouchDB Error")
                return completion(nil, .internalServerError)
            }
            completion(book, nil)
        }
    }
}</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 7:</span> Test saving a document to the database</h2>
        <p>Now we're going to test our route by passing in a book and checking that it is saved to the database.</p>
        <p>First we need to start our Kitura server.</p>
        <p>Once the server is running, open a terminal and run the following:</p>
        <pre><code>curl -X POST \
      http://localhost:8080/couch \
      -H 'content-type: application/json' \
      -d '{
      "id": 0,
      "title": "A Game of Thrones",
      "price": 14.99,
      "genre": "Fantasy"
  }'</code></pre>
      <p>This will make a POST request to the server and we should be returned our book in JSON format:</p>
      <pre><code>{"id":0,"title":"A Game of Thrones","price":14.99,"genre":"Fantasy"}</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 8:</span> Retrieve the document from the database</h2>
        <p>Next we're going to retrieve our document from the database. To retrieve all the documents from a CouchDB database we need to use the aptly named `retrieveAll` method.</p>
        <p>So now let's add that functionality to the route handler we created earlier called `couchFindAllHandler`:</p>
        <pre><code class="language-swift">func couchFindAllHandler(completion: @escaping ([Book]?, RequestError?) -> Void) {
    App.couchDBClient.retrieveDB("bookstore") { (database, error) in
        guard let database = database  else {
            return completion(nil, .internalServerError)
        }
        database.retrieveAll(includeDocuments: true, callback: { (allDocuments, error) in
            if let error = error {
                Log.error(error.localizedDescription)
                return completion(nil, RequestError(httpCode: error.statusCode))
            }
            guard let allDocuments = allDocuments else {
                Log.error("Unknown CouchDB Error")
                return completion(nil, .internalServerError)
            }
            let books = allDocuments.decodeDocuments(ofType: BookDocument.self).map({$0.value})
            completion(books, nil)
        })
    }
}</code></pre>
        <p>When we made the call to `retrieveAll` we set the `includeDocuments` parameter to true, this means that each row, or document, returned from the database will have an additional field called "doc" in it which contains the JSON document. These documents can then be decoded to a given Swift type using `decodeDocuments(ofType:)` which is how we're obtaining the `books` value.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 9:</span> Test retrieving documents from the database</h2>
        <p>If you have followed the guide so far then you will now have a book document in your database, which we can retrieve using the code we just wrote.</p>
        <p>To do this, start the server and navigate to: <a target="_blank" href="http://localhost:8080/couch">http://localhost:8080/couch.</a></p>
        <p>This will call GET on the `/couch` route and we will see the book we posted earlier returned in JSON format. The book data persists even if we restart the Kitura server as it is now stored in a database.</p>
      </main>
    </div>
    <div id="top-page" class="top-page">
      <a href="#">Back to top</a>
    </div>
  </section>
  <script type="text/javascript" src="../../scripts/learn.js"></script>
  <script src="../../scripts/prism.js"></script>
</body>
</html>
