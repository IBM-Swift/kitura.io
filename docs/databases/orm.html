<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
    </script>
    <title>Learn - Getting Started</title>
    <link rel="icon" type="image/png" href="../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicon-16x16.png" sizes="16x16" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/docs.css">
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
  </head>
  <body>
    <h1>Swift Kuery ORM</h1>
    <h2>Prerequisites</h2>
    <ul class="plain-list">
      <li><span class="blue-text">Kitura Server:</span> Learn how to create one in our getting started guide</li>
      <li><span class="blue-text">Routing:</span> Learn how to add routes in our routing guides</li>
      <li><span class="blue-text">Updated Package.swift:</span> Learn how to update the Package.swift in our guide</li>
    </ul>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 1:</span> Add Swift Kuery ORM to the project</h2>
    <p>import Swift Kuery ORM to our project:</p>
    <pre>import SwiftKueryORM</pre>
    <p>To work with the ORM we need to have a Database plugin to use.</p>
    <p>In this example we will be using <a>SwiftKueryPostgreSQL</a>:</p>
    <pre>import SwiftKueryPostgreSQL</pre>
    <div class="info">
      <p>You can use any database plugin but ensure that it's been added to your Package.swift.</p>
    </div>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 2:</span> Update our Model</h2>
    <p>The key component of Swift Kuery ORM is the Model protocol.</p>
    <p>All we need to do to make use of the Model protocol is create an extension for our Model:</p>
    <pre>extension Book: Model { }</pre>
    <p>The Model protocol extends what Codable provides to work with the ORM.</p>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 3:</span> Create a database connection</h2>
    <h3>Install the PostgreSQL client</h3>
    <p>To use Swift-Kuery-PostgreSQL you need to have the appropiate PostgreSQL C-language client installed.</p>
    <h4>macOS</h4>
    <p>On macOS we can use Homebrew to install Postgres:</p>
    <pre>brew install postgresql</pre>
    <h4>Linux</h4>
    <p>On Linux we can use `apt-get` to install Postgres:</p>
    <pre>sudo apt-get install libpq-dev</pre>
    <h3>Create a PostgreSQL database</h3>
    <p>Now that we have PostgreSQL installed we can create a database:</p>
    <pre>createdb bookdb</pre>
    <p>Now we're ready to connect to our database from our Kitura server.</p>
    <h3>Create a PostgreSQL connection pool</h3>
    <p>Next we create an instance of a PostgreSQL connection:</p>
    <pre>let pool = PostgreSQLConnection.createPool(host: "localhost", port: 5432, options: [.databaseName("bookdb")], poolOptions: ConnectionPoolOptions(initialCapacity: 10, maxCapacity: 50))
Database.default = Database(pool)</pre>
    <h3>Create a table in the database</h3>
    <p></p>
    <pre>do {
    try Book.createTableSync()
} catch let error {
    print(error)
}</pre>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 4:</span> Save an Object to our database</h2>
    <div class="info">
      <p>We are no longer using a Dictionary to store data. If you followed the Codable routing guide to get here then make sure you remove all the `bookStore` code.</p>
    </div>
    <p>If we want to save a new object to our database we have to use the save() method.</p>
    <p>In our handler for the POST route we can add the following:</p>
    <pre>book.save(completion)</pre>
    <p>The POST handler should look similar to this:</p>
    <pre>func postHandler(book: Book, completion: @escaping (Book?, RequestError?) -> Void) {
    book.save(completion)
    completion(book, nil)
}</pre>
    <p>That's all we need to do. With that line any Book data posted to the `/books` end point will be stored in our database.</p>
    <p>All we need to do now is be able to retrieve data from our database.</p>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 5:</span> Retrieve an Object from your database</h2>
    <p>If we want to retrieve all the Book data from our database we use the `findAll` method.</p>
    <p>This will return an array containing the all the books.</p>
    <p>In our handler for getting all the books we can add the following:</p>
    <pre>Book.findAll { books, error in
  guard let books = books else {
    completion(nil, .internalServerError)
    return
  }
  completion(books, nil)
}</pre>
    <p>The GET handler should look similar to this:</p>
    <pre>func getAllHandler(completion: @escaping ([Book]?, RequestError?) -> Void) {
  Book.findAll { books, error in
    guard let books = books else {
      completion(nil, .internalServerError)
      return
    }
    completion(books, nil)
  }
}</pre>
    <p>We've added some error handling here as well. We check to ensure we got something back, otherwise there's an error with the server.</p>
    <p>Even an empty Array is a valid response.</p>
    <p>Now we can test our Database using cURL to ensure everything is working correctly.</p>
    <div class="info">
      <p>Kitura has support for OpenAPI which makes testing Codable routes easy and provides a UI for testing.</p>
      <p>You can add OpenAPI to your server using our OpenAPI guide.</p>
    </div>
    <p>Firstly we need to start our Kitura server</p>
    <p>Then in a terminal:</p>
    <pre>curl -X POST \
  http://localhost:8080/books \
  -H 'content-type: application/json' \
  -d '{
    "name": "Sarah",
    "age": 32,
    "active": true
}'</pre>
    <p>You should see the following:</p>
    <pre>{"name":"Sarah","age":32,"active":true}%</pre>
    <p>Next we can retrieve the data back.</p>
    <p>In a terminal:</p>
    <pre>curl -X GET \
  http://localhost:8080/books \
  -H 'content-type: application/json'</pre>
    <p>Again you should see the following:</p>
    <pre>{"name":"Sarah","age":32,"active":true}%</pre>
    <p>If we stop the server, and then restart it and run the following in a terminal again:</p>
    <pre>curl -X GET \
  http://localhost:8080/books \
  -H 'content-type: application/json'</pre>
    <p>You should still see the following output:</p>
    <pre>{"name":"Sarah","age":32,"active":true}%</pre>
    <p>Our data has persisted even though our server has been stopped. This is one of the many perks of using a database.</p>
    <div class="underline"></div>
    <h2>Next steps</h2>
    <p><span class="blue-text bold">Add logging:</span> Get useful feedback from your server about startup and errors</p>
    <p><span class="blue-text bold">Add routing:</span> Add REST APIs, such as HTTP GET, to your server</p>
  </body>
</html>
