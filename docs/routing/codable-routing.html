<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
    </script>
    <title>Learn - Getting Started</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/docs.css">
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
  </head>
  <body>
    <h1>Codable Routing</h1>
    <p class="block-text">Codable routing is where the router handlers are just normal functions you might define elsewhere in your code; they take struct or class types as parameters, and respond with stuct or class types via a completion handler. The only requirement is that those types conform to the Codable protocol introduced in Swift 4 (hence the name).</p>
    <div class="underline"></div>
    <h2>Contents:</h2>
    <ol class="plain-list">
      <h3><li><a href="#prereq">Prerequisites</a></li></h3>
      <p>This section will inform you of the minimum you need to have setup to follow this guide.</p>
      <h3><li><a href="#post">Create a basic POST route</a></li></h3>
      <p>Learn how to send data to a Kitura server using Codable types.</p>
      <h3><li><a href="#getall">Create a basic GET ALL route</a></li></h3>
      <p>Learn how to retrieve all data from a Kitura server.</p>
      <h3><li><a href="#step3">Create a basic GET SINGLE route</a></li></h3>
      <p>Learn how to get a single value from a Kitura server.</p>
    </ol>
    <div class="underline"></div>
    <h2 id="prereq">Prerequisites</h2>
    <ul class="plain-list">
      <li><span class="blue-text">Kitura Server:</span> Learn how to create one in our Getting Started guide</li>
      <li>Your project is set up as described by our style guide.</p>
      <li>Your project is assumed to be called `MyKituraApp`. If you used a different name, substitute in your chosen name.</li>
      <li>You have defined a `Book` struct as described in the Codable routing section of "What is routing?"</li>
    </ul>
    <div class="underline"></div>
    <h2 id="post"><span class="blue-text">Step 1:</span> Create a POST Codable Route</h2>
    <p>Open your Application.swift file:</p>
    <pre><code class="language-swift">open Sources/MyKituraApp/Application.swift</code></pre>
    <p>Inside the `postInit()` function add:</p>
    <pre><code class="language-swift">router.post("/books", handler: postHandler)</code></pre>
    <p>What we've done is register a POST on our router that will handle any POST requests made on "/books".</p>
    <p>This will not compile as we haven't actually implemented the postHandler yet. So lets go ahead and do that.</p>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 2:</span> Define the postHandler</h2>
    <p>The postHandler is a block of code, called a closure, that is executed when a POST request is made to "/books".</p>
    <p>Underneath the `postInit()` function add the following:</p>
    <pre><code class="language-swift">func postHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
    // Point where developer code would interact with the input book.
    completion(book, nil)
}</code></pre>
    <p>The result should look similar to this:</p>
    <pre><code class="language-swift">func postInit() throws {
    router.post("/books", handler: postHandler)
}

func postHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
    // Point where developer code would interact with the input book.
    completion(book, nil)
}</code></pre>
    <p>We can now successfully compile the project!</p>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 3:</span> Test the POST route</h2>
    <div class="info">
      <p>Kitura has support for OpenAPI which makes testing Codable routes easy and provides a UI for testing.</p>
      <p>You can add OpenAPI to your server using our OpenAPI guide.</p>
    </div>
    <p>With the project now compiling we can start the server.</p>
    <p>Once the server is running open a terminal window and enter the following:</p>
    <pre><code>curl -X POST \
  http://localhost:8080/books \
  -H 'content-type: application/json' \
  -d '{
    "id": 0,
    "title": "A Game of Thrones",
    "price": 14.99,
    "genre": Fantasy
}'</code></pre>
    <p>We can use the cURL command to send a request to our server.</p>
    <p>If your Codable route was created correctly you should see the following:</p>
    <pre><code>{"id": 0,"title":"A Game of Thrones","price":14.99,"genre":"Fantasy"}%</code></pre>
    <p>We have just successfully posted a book to the server and had it returned.
         In the databases section, we will see how to save this Book from our handler.</p>
    <div class="underline"></div>
    <h2 id="getall"><span class="blue-text">Step 4:</span> Create a GET ALL Codable Route</h2>
    <p>We register a GET route in a similar way to the POST route.</p>
    <p>Below the line `router.post("/books", handler: postHandler)` add:</p>
    <pre><code class="language-swift">router.get("/books", handler: getAllHandler)</code></pre>
    <p>Just like before we now need to define the handler.</p>
    <p>Below the `postHandler` function add:</p>
    <pre><code class="language-swift">func getAllHandler(completion: ([Book]?, RequestError?) -> Void) {
        let books = [Book(id: 0, title: "Harry Potter", price: 10.99, genre: "Fantasy"),
                     Book(id: 1, title: "Server Side Swift with Kitura", price: 59.99, genre: "Nonfiction")]
        completion(books, nil)
    }</code></pre>
    <p>You may have noticed that the completion here is expecting an array of books.</p>
    <p>That is because our route provides no identifier so we will retrieve all of the books.</p>
    <p>The result of all the changes should look something like this:</p>
    <pre><code class="language-swift">func postInit() throws {
        router.post("/books", handler: postHandler)
        router.get("/books", handler: getAllHandler)
    }
    func postHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
        // Point where developer code would interact with the input book.
        completion(book, nil)
    }
    func getAllHandler(completion: ([Book]?, RequestError?) -> Void) {
        let books = [Book(id: 0, title: "Harry Potter", price: 10.99, genre: "Fantasy"),
                     Book(id: 1, title: "Server Side Swift with Kitura", price: 59.99, genre: "Nonfiction")]
        completion(books, nil)
    }
    </code></pre>
    <p>Now we can restart our server to test our new endpoint.</p>
    <p>Once the server is running, open your browser at:</p>
    <p><a href="http://localhost:8080/books" target="_blank">localhost:8080/books</a></p>
    <p>This will make a get request to the server and you should see our two books in JSON format:</p>
    <pre><code class="language-swift">[{"id":0,"title":"Harry Potter","price":10.99,"genre":"Fantasy"},{"id":1,"title":"Server Side Swift with Kitura","price":59.99,"genre":"Nonfiction"}]</code></pre>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 5:</span>Create a GET ONE Codable Route</h2>
    <p>We register a second GET route in a similar way to our first.</p>
    <p>Below the line `router.get("/books", handler: getAllHandler)` add:</p>
    <pre><code class="language-swift">router.get("/books", handler: getOneHandler)</code></pre>
    <p>Just like before we now need to define the handler.</p>
    <p>Below the `getAllHandler` function add:</p>
    <pre><code class="language-swift">func getOneHandler(id: Int, completion: (Book?, RequestError?) -> Void) {
        let books = [Book(id: 0, title: "Harry Potter", price: 10.99, genre: "Fantasy"),
                     Book(id: 1, title: "Server Side Swift with Kitura", price: 59.99, genre: "Nonfiction")]
        guard id < books.count, id >= 0 else {
            return completion(nil, .badRequest)
        }
        completion(books[id], nil)
    }</code></pre>
    <p>In this completion, we are provided an identifier.</p>
    <p>This is the value following your route and can be either an `Int` or a `String`.</p>
    <p>We then use this identifier to return a single `Book.`</p>
    <p>The result of all the changes should look something like this:</p>
    <pre><code class="language-swift">func postInit() throws {
        router.post("/books", handler: postHandler)
        router.get("/books", handler: getAllHandler)
        router.get("/books", handler: getOneHandler)
    }
    func postHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
        // Point where developer code would interact with the input book.
        completion(book, nil)
    }
    func getAllHandler(completion: ([Book]?, RequestError?) -> Void) {
        let books = [Book(id: 0, title: "Harry Potter", price: 10.99, genre: "Fantasy"),
                     Book(id: 1, title: "Server Side Swift with Kitura", price: 59.99, genre: "Nonfiction")]
        completion(books, nil)
    }
    func getOneHandler(id: Int, completion: (Book?, RequestError?) -> Void) {
        let books = [Book(id: 0, title: "Harry Potter", price: 10.99, genre: "Fantasy"),
                     Book(id: 1, title: "Server Side Swift with Kitura", price: 59.99, genre: "Nonfiction")]
        guard id < books.count, id >= 0 else {
            return completion(nil, .badRequest)
        }
        completion(books[id], nil)
    }
    </code></pre>
    <p>Now we can restart our server to test our new endpoint.</p>
    <p>Once the server is running, open your browser at:</p>
    <p><a href="http://localhost:8080/books/0" target="_blank">localhost:8080/books/0</a></p>
    <p>This will make a get request to the server and you should see the first book in JSON format:</p>
    <pre><code class="language-swift">{"id":0,"title":"Harry Potter","price":10.99,"genre":"Fantasy"}</code></pre>
    <p>Then open your browser at:</p>
    <p><a href="http://localhost:8080/books/1" target="_blank">localhost:8080/books/1</a></p>
    <p>This will make a new get request to the server and you should see the second book in JSON format:</p>
    <pre><code class="language-swift">{"id":1,"title":"Server Side Swift with Kitura","price":59.99,"genre":"Nonfiction"}</code></pre>
    <div class="underline"></div>
    <h2>Next steps</h2>
    <p><span class="blue-text bold"><a onclick="setActiveSidebarElementForParent('open-api')" href="open-api.html#">Add Kitura OpenAPI:</a></span> Provides a UI for viewing information about Codable routes.</p>
    <!-- <p><span class="blue-text bold">Add Sessions:</span> Some blurb about Sessions</p>
    <p><span class="blue-text bold">Add Authentication:</span> Some blurb about Authentication</p> -->
    <script type="text/javascript" src="../../scripts/docs.js"></script>
    <script type="text/javascript" src="../../scripts/prism.js"></script>
  </body>
</html>
