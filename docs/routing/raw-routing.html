<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
    </script>
    <title>Learn - Raw Routing</title>
    <link rel="icon" type="image/png" href="../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicon-16x16.png" sizes="16x16" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/docs.css">
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
  </head>
  <body>
    <h1>Raw Routing</h1>
    <h2>Prerequisites</h2>
    <ul class="plain-list">
      <li><span class="blue-text">Kitura Server:</span> Learn how to create one in our Getting Started guide</li>
    </ul>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 1:</span> Create a POST route</h2>
    <div class="info">
      <p>If you created your project using Kitura CLI or the Kitura macOS app then your project structure may be different.</p>
      <p>The file you will be working with is:</p>
      <pre>/Sources/Application/Application.swift</pre>
    </div>
    <p>Open your main.swift file:</p>
    <pre>open Sources/MyKituraApp/main.swift</pre>
    <p>Below the line `let router = Router()` add:</p>
    <pre>router.post("/books") { request, response, next in
    next()
}</pre>
    <p>What we've done is register a POST on our router that will handle any POST requests made on "/books".</p>
    <div class="info">
      <p>If the values `request`, `repsonse` and `next` are unfamiliar to you then you can learn more about them in our What is Routing? guide.</p>
    </div>
    <p>Our POST route will be used to send the title of books to our server therefore we need a way of reading this data.</p>
    <p>To do this we can tap into the `readString` method of the RouterRequest class:</p>
    <pre>request.readString()</pre>
    <p>This method takes the body of the request, the data we're posting, and tries to convert it to a String.</p>
    <p>We will add this method to our POST route:</p>
    <pre>router.post("/books") { request, response, next in
    do {
        try request.readString()
    } catch {
        Log.error(error.localizedDescription)
    }
    next()
}</pre>
    <p>The `readString` method can throw so we need to wrap it in a do-catch block.</p>
    <p>To test this route works, we can the `send()` method of the RouterResponse to send the result of `request.readString()`:</p>
    <pre>router.post("/books") { request, response, next in
    do {
        try response.send(request.readString())
    } catch {
        Log.error(error.localizedDescription)
    }
    next()
}</pre>
    <p>Now if we start our Kitura server we can use curl to test our route.</p>
    <p>In a terminal enter the following:</p>
    <pre>curl -X POST \
  http://localhost:8080/books \
  -H 'content-type: text/plain' \
  -d 'A Game of Thrones'</pre>
    <p>We should then see the following printed to the terminal:</p>
    <pre>A Game of Thrones%</pre>
    <p>That's it! We've implemented a basic POST route.</p>
    <div class="info">
      <p>We're using plain text here for our data. For a complex object like a Book, which could have several properties, JSON would be the better solution.</p>
    </div>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 2:</span> Create a GET route</h2>
    <p>We register a GET route in a similar way to the POST route.</p>
    <p>Below the line `router.post("/books")...` add:</p>
    <pre>router.get("/books") { request, response, next in
    next()
}</pre>
    <p>In a GET route we can simply just respond with the data we want:</p>
    <pre>router.get("/books") { request, response, next in
  reponse.send("A Game of Thrones")
  next()
}</pre>
    <p>Now if we need to restart our server.</p>
    <p>Open <a href="http://localhost:8080/books">http://localhost:8080/books</a></p>
    <p>We should see the following in our browser:</p>
    <pre>A Game of Thrones</pre>
    <p>That's it! We've now also implemented a simple GET route.</p>
    <p>Now we need to be able to `get` the data we `post`</p>
    <div class="underline"></div>
    <h2><span class="blue-text">Step 3:</span> Store and retrieve data from the server (Optional)</h2>
    <p>First we need to create a way for the server to store the data we send.</p>
    <p>To do this we will use an Array.</p>
    <div class="info">
      <p>It's worth noting using an Array not good practice. The better solution would be to create a Database to store the data.</p>
      <p>You can learn how to do this in our Database guide.</p>
    </div>
    <p>Just below the line `let router = Router()` add the following:</p>
    <pre>var bookStore: [String] = []</pre>
    <p>Next we need to modify our POST route to store the data into the array:</p>
    <pre>router.post("/books") { request, response, next in
    do {
        guard let title = try request.readString() else {
            Log.error("Could not read body as a String")
            return
        }
        bookStore.append(title)
    } catch {
        Log.error(error.localizedDescription)
    }
    next()
}</pre>
    <p>We need to employ some error handling here incase the body doesn't contain any data.</p>
    <p>Now we modify our GET route to respond with the `bookStore` array:</p>
    <pre>response.send(json: bookStore)</pre>
    <p>To test we need to restart the Kitura server.</p>
    <p>Open <a href="http://localhost:8080/books">http://localhost:8080/books</a></p>
    <p>In the browser you should see:</p>
    <pre>[]</pre>
    <p>An empty array makes sense as we haven't posted any data.</p>
    <p>In a terminal enter the following:</p>
    <pre>curl -X POST \
  http://localhost:8080/books \
  -H 'content-type: text/plain' \
  -d 'A Game of Thrones'</pre>
    <p>If we refresh the browser we should see:</p>
    <pre>["A Game of Thrones"]</pre>
    <p>We can make as many posts as we'd like and our Array would be updated.</p>
    <p>However if the server is restarted, all data will be lost and we'd have an empty array again.</p>
    <p>This is one of the flaws of using an Array as the data store.</p>
    <p>In the Database Guide we will look to resolve this issue.</p>
    <div class="underline"></div>
    <h2>Next steps</h2>
    <p><span class="blue-text bold">Add logging:</span> Get useful feedback from your server about startup and errors</p>
    <p><span class="blue-text bold">Add routing:</span> Add REST APIs, such as HTTP GET, to your server</p>
  </body>
</html>
