<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
			<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

		gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <title>Kitura Raw Session</title>
    <link rel="icon" type="image/png" href="../../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../../assets/favicon-16x16.png" sizes="16x16" />
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/dist/docs.css">
  </head>
<body>
  <section class="docs-grid-container">
    <aside id="sidebar" class="docs-item-1 docs-sidebar">
      <h1 class="docs-title"><a href="/index.html">KITURA <span class="blue-text">DOCS</span></a></h1>
      <div class="underline-title"></div>
      <ul class="sidebar-list">
        <li class="sidebar-item collapsible">Getting Started</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../getting-started/installation-mac.html">Installation for macOS</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/installation-linux.html">Installation for Linux</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/create-server.html">Create a server</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/style-guide.html">Style Guide</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/update-package.html">Adding Packages</a></li>
        </ul>
        <li class="sidebar-item collapsible">Logging</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../logging/logging.html">What is Logging?</a></li>
          <li class="nested-sidebar-item"><a href="../logging/helium-logger.html">Helium Logger</a></li>
        </ul>
        <li class="sidebar-item collapsible">Routing</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../routing/routing.html">What is routing?</a></li>
          <li class="nested-sidebar-item"><a href="../routing/codable-routing.html">Codable routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/raw-routing.html">Raw routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/open-api.html">OpenAPI</a></li>
        </ul>
        <li class="sidebar-item collapsible">Databases</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../databases/databases.html">What are Databases?</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery-orm.html">SQL: ORM</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery.html">SQL: Kuery</a></li>
          <li class="nested-sidebar-item"><a href="../databases/couchdb.html">NoSQL: CouchDB</a></li>
        </ul>
        <li class="sidebar-item collapsible">Sessions</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../sessions/sessions.html">What are Sessions?</a></li>
          <li class="nested-sidebar-item active"><a href="../sessions/raw-sessions.html">Kitura Raw Session</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/kitura-session.html">Kitura TypeSafeSession</a></li>
        </ul>
        <li class="sidebar-item collapsible">Authentication</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../authentication/authentication.html">What is Authentication?</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/typesafe-auth.html">Type-Safe Credentials</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/jwt-auth.html">JSON Web Tokens</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/fb-google-oauth2.html">OAuth 2.0 with Facebook/Google</a></li>
        </ul>
        <li class="sidebar-item collapsible">Web Application</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../templating/templating.html">What is templating?</a></li>
          <li class="nested-sidebar-item"><a href="../templating/stencil.html">Stencil</a></li>
          <li class="nested-sidebar-item"><a href="../templating/markdown.html">Markdown</a></li>
        </ul>
        <li class="sidebar-item collapsible">Deploying</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../deploying/monitoring.html">Monitoring</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/ssl.html">Enabling SSL/TLS</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/docker.html">Docker</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/kubernetes.html">Kubernetes</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/cloud-foundry.html">Cloud Foundry</a></li>
        </ul>
      </ul>
    </aside>
    <div id="burgerIcon" class="burger-icon" onclick="showSidebar()">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
    <div class="docs-item-2 search-container">
      <!-- <input class="docs-search" type="text" name="searchInput" placeholder="Search documentation..."> -->
      <div id="beta" class="temp-beta">
        <h4>Currently in Beta - <a href="../../old-learn.html">View old docs</a></h4>
      </div>
    </div>
    <nav class="docs-item-3 docs-nav">
      <button id="api-button" class="apiref-button" type="button" name="button" onclick="window.open('https://ibm-swift.github.io/Kitura/')">API Reference</button>
      <a class="nav-item" target="_blank" href="http://slack.kitura.io/">Need help?</a>
      <a class="nav-item" target="_blank" href="https://github.com/IBM-Swift/kitura.io/issues">Found an issue?</a>
    </nav>
    <div id="doc-container" class="docs-item-4 docs-window">
      <main>
        <h1 class="heading-1">Kitura Session</h1>
        <p class="block-text">HTTP is a stateless connection protocol, that is the server can't distinguish one request from another. Sessions and cookies provide HTTP with state, they allow the server to know who is making a specific request and respond accordingly.</p>
        <p class="block-text">This guide demonstrates <a target="_blank" href="https://github.com/IBM-Swift/Kitura-Session">Kitura Session</a> with Raw routing.</p>
        <h2 class="heading-2">Prerequisites</h2>
        <ul class="plain-list">
          <li><a onclick="setActiveSidebarElementForParent('create-server')" href="../getting-started/create-server.html#">Kitura Server:</a> Learn how to create one in our Getting Started guide.</li>
          <li><a onclick="setActiveSidebarElementForParent('style-guide')" href="../getting-started/style-guide.html#">Kitura Style Guide:</a> Follow our guide to see how a production ready server should be structured.</li>
        </ul>
        <h2 class="heading-2"><span class="blue-text">Step 1:</span> Create your session routes</h2>
        <p>In this guide we are going to create three Kitura routes:</p>
        <ul>
            <li><p>A GET route, where we will retrieve the books from out session</p></li>
             <li><p>A POST route, where we store a book in our session</p></li>
         </ul>
         <p>In this step we will create the framework for our protected and log out routes.</p>
         <p>Firstly, we need to add Kitura-Session to our dependencies as described by the <a target="_blank" href="https://github.com/IBM-Swift/Kitura-Session#usage">usage section</a> of the README.</p>
         <p>Once that is complete, open your `Application.swift` file in your default text editor (or Xcode if you prefer):</p>
         <pre><code>open Sources/Application/Application.swift</code></pre>
         <p> Inside the `postInit()` function add: </p>
         <pre><code class="language-swift">initializeRawSessionRoutes(app: self)</code></pre>
         <p>Next, create a new file, called `RawSessionRoutes.swift`, to contain the framework for our routes code:</p>
         <pre><code class="language-swift">import KituraSession

func initializeRawSessionRoutes(app: App) {
    // Define the Session here

    app.router.get("/rawsession") { request, response, next in
        // Get the books from the session here
        next()
    }

    app.router.post("/rawsession") { request, response, next in
        // Add books to the session here
        next()
    }
}</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text bold">Step 2:</span> Set up a session</h2>
        <p class="block-text">We will use a session to persist data between the users requests.
            The session will provide the user with a cookie that the user will attach to future requests.
            That cookie is then linked to a session store where we keep data we want to be associated with that users cookie.
            This allows us to add features such as an online shopping cart, where multiple requests add items to the cart until we are ready to checkout.</p>
        <p>When creating a session we provide the following parameters:</p>
        <ul>
          <li><span class="blue-text">secret:</span> A `String` to be used for session encoding. This is your sessions password and should be treated as such.</li>
          <li><span class="blue-text">cookie:</span> A list of options for session's cookies. We will use this to set the cookies name.</li>
          <li><span class="blue-text">store:</span> A session backing store that implements the `Store` protocol. This determines where session data is persisted. We have not set this meaning the data is persisted on the server.</li>
        </ul>
        <div class="info">
            <p>For live applications, you should use a persistent store such as a database or <a target="_blank" href="https://github.com/IBM-Swift/Kitura-Session-Redis">Kitura-Session-Redis</a></p>
        </div>
        <p>To set up our session, we create a `Session` middleware with our desired parameters.</p>
        <p>Inside your `initializeRawSessionRoutes`, add the following code:</p>
        <pre><code class="language-swift">let session = Session(secret: "password", cookie: [CookieParameter.name("Raw-cookie")])</code></pre>
        <p>Below this line, we register the middleware on our router:</p>
        <pre><code class="language-swift">app.router.all(middleware: session)</code></pre>
        <p>We should now have access to our session using `request.session`.</p>
        <p>We check that this is true by adding the following `guard` statement to all of our route handlers:</p>
        <pre><code class="language-swift">guard let session = request.session else {
    return try response.status(.internalServerError).end()
}</code></pre>
        <p>Our `RawSessionRoutes.swift` file should now look as follows:</p>
        <pre><code class="language-swift">import KituraSession

func initializeRawSessionRoutes(app: App) {
    let session = Session(secret: "password", cookie: [CookieParameter.name("Raw-cookie")])
    app.router.all(middleware: session)

    app.router.get("/rawsession") { request, response, next in
        guard let session = request.session else {
            return try response.status(.internalServerError).end()
        }
        // Get the books from the session here
        next()
    }

    app.router.post("/rawsession") { request, response, next in
        guard let session = request.session else {
            return try response.status(.internalServerError).end()
        }
        // Add books to the session here
        next()
    }
}</code></pre>
    <div class="underline"></div>
    <h2 class="heading-2"><span class="blue-text">Step 3:</span> Add the session GET route</h2>
    <p>Now we have access to our session, we can use it to persist data.</p>
    <p>We are going to be persisting the `Book` model from the <a onclick="setActiveSidebarElementForParent('style-guide')" href="../getting-started/style-guide.html#">Kitura Style Guide</a>, but you can use any `Codable` Swift type.</p>
    <p>The session is stored as a `[String: Any]` dictionary, however by declaring the expected type, we can directly decode our model from the session.</p>
    <p>In our case, we decode an array of books by adding the following code to our GET handler:</p>
    <pre><code class="language-swift">let books: [Book] = session["books"] ?? []</code></pre>
    <p>This we get all the books stored for the "books" key in our model. If there are no books it returns an empty array.</p>
    <p>Once we have our books, we send them to the user in the response:</p>
    <pre><code class="language-swift">response.send(books)</code></pre>
    <p>Our completed GET route should now look as follows:</p>
    <pre><code class="language-swift">app.router.get("/rawsession") { request, response, next in
    guard let session = request.session else {
        return try response.status(.internalServerError).end()
    }
    let books: [Book] = session["books"] ?? []
    response.send(books)
    next()
}</code></pre>
    <div class="underline"></div>
    <h2 class="heading-2"><span class="blue-text">Step 4:</span> Add the session POST route</h2>
    <p>Now we need some books to retrieve. We will do this by adding a book a that has posted into our route.</p>
    <p>The first thing we need to do is decode the book.</p>
    <p>We do this by adding the following code to our POST handler:</p>
    <pre><code class="language-swift">let inputBook = try request.read(as: Book.self)</code></pre>
    <p>Next we need to get the books that are currently in the session:<p>
    <pre><code class="language-swift">var books: [Book] = session["books"] ?? []</code></pre>
    <p>Now we append our new book to the existing books and store it in the session for the "books" key:</p>
    <pre><code class="language-swift">books.append(inputBook)
session["books"] = books</code></pre>
    <p>Finally we respond with the input book to represent a successful request</p>
    <pre><code class="language-swift">response.status(.created)
response.send(inputBook)</code></pre>
        <p>Our completed POST route should now look as follows:</p>
        <pre><code class="language-swift">app.router.post("/rawsession") { request, response, next in
    guard let session = request.session else {
        return try response.status(.internalServerError).end()
    }
    let inputBook = try request.read(as: Book.self)
    var books: [Book] = session["books"] ?? []
    books.append(inputBook)
    session["books"] = books
    response.status(.created)
    response.send(inputBook)
    next()
}</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 5:</span> Test our Session</h2>
        <p>We have now completed the code for our session.
             This will allow us to add books to our cart and persist them between requests.</p>
        <p>Our completed `RawSessionRoutes.swift` file should now look as follows:</p>
        <pre><code class="language-swift">import KituraSession

func initializeRawSessionRoutes(app: App) {
    let session = Session(secret: "password", cookie: [CookieParameter.name("Raw-cookie")])
    app.router.all(middleware: session)

    app.router.get("/rawsession") { request, response, next in
        guard let session = request.session else {
            return try response.status(.internalServerError).end()
        }
        let books: [Book] = session["books"] ?? []
        response.send(books)
        next()
    }

    app.router.post("/rawsession") { request, response, next in
        guard let session = request.session else {
            return try response.status(.internalServerError).end()
        }
        let inputBook = try request.read(as: Book.self)
        var books: [Book] = session["books"] ?? []
        books.append(inputBook)
        session["books"] = books
        response.status(.created)
        response.send(inputBook)
        next()
    }
}</code></pre>
        <p>To test our POST route, we will send a requests using curl with cookies enabled.</p>
        <p>Open Terminal and enter the following:</p>
        <pre><code>curl -X POST \
http://localhost:8080/rawsession \
-b cookies.txt -c cookies.txt \
-H 'content-type: application/json' \
-d '{
    "id": 1,
    "title": "War and Peace",
    "price": 10.99,
    "genre": "Historical drama"
}'</code></pre>
        <p>If our request was successful, our book will be returned to us:</p>
        <pre><code>{"id":1,"title":"War and Peace","price":10.99,"genre":"Historical drama"}</code></pre>
        <p>We will also have a cookie that curl has stored in the `cookies.txt` file.</p>
        <p>To retrieve our book, we make another curl request to our server:</p>
        <pre><code>curl -X GET \
http://localhost:8080/rawsession \
-b cookies.txt -c cookies.txt</code></pre>
    <p>If the request is successful, it will return the book we just sent to the server.</p>
    <pre><code>[{"id":1,"title":"War and Peace","price":10.99,"genre":"Historical drama"}]</code></pre>
    <p>The cookie we sent with our request has identifed our session so that our saved book can be returned.</p>
    <p>Each users making requests to these routes will create their own basket of books.</p>
    <p>We can demonstrate this by deleting our cookie:</p>
    <pre><code>rm cookies.txt</code></pre>
    <p>Followed by making a new GET request:</p>
    <pre><code>curl -X GET \
http://localhost:8080/rawsession \
-b cookies.txt -c cookies.txt</code></pre>
    <p>This represents a user without a session and so we are returned an empty array:</p>
    <pre><code>[]</code></pre>
        <h2 class="heading-2">Next steps</h2>
         <p><span class="blue-text bold"><a onclick="setActiveSidebarElementForParent('typesafe-auth')" href="../authentication/typesafe-auth.html#">Authentication:</a></span> Learn about authentication and what Kitura provides.</p>
      </main>
    </div>
    <div id="top-page" class="top-page">
      <a href="#">Back to top</a>
    </div>
  </section>
  <script type="text/javascript" src="../../scripts/learn.js"></script>
  <script src="../../scripts/prism.js"></script>
</body>
</html>
