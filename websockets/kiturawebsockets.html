<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
			<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

		gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <title>WebSockets Echo Server</title>
    <link rel="icon" type="image/png" href="../../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../../assets/favicon-16x16.png" sizes="16x16" />
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/dist/docs.css">
  </head>
<body>
  <section class="docs-grid-container">
    <aside id="sidebar" class="docs-item-1 docs-sidebar">
      <h1 class="docs-title"><a href="/index.html">KITURA <span class="blue-text">DOCS</span></a></h1>
      <div class="underline-title"></div>
      <ul class="sidebar-list">
        <li class="sidebar-item collapsible">Getting Started</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../getting-started/installation-mac.html">Install Swift for macOS</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/installation-linux.html">Install Swift for Linux</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/hello-world.html">Hello World</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/create-server.html">Create a server</a></li>

          <li class="nested-sidebar-item"><a href="../getting-started/update-package.html">Adding Packages</a></li>
        </ul>
        <li class="sidebar-item collapsible">Logging</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../logging/logging.html">What is Logging?</a></li>
          <li class="nested-sidebar-item"><a href="../logging/helium-logger.html">Helium Logger</a></li>
        </ul>
        <li class="sidebar-item collapsible">Routing</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../routing/routing.html">What is routing?</a></li>
          <li class="nested-sidebar-item"><a href="../routing/codable-routing.html">Codable routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/raw-routing.html">Raw routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/open-api.html">OpenAPI</a></li>
        </ul>
        <li class="sidebar-item collapsible">Databases</li>
        <ul class="nested-sidebar-list content" style="max-height: 250px;">
          <li class="nested-sidebar-item active"><a href="../databases/databases.html">What are Databases?</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery-orm.html">SQL: ORM</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery.html">SQL: Kuery</a></li>
          <li class="nested-sidebar-item"><a href="../databases/couchdb.html">NoSQL: CouchDB</a></li>
        </ul>
        <li class="sidebar-item collapsible">Sessions</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../sessions/sessions.html">What are Sessions?</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/kitura-session.html">Raw Routing Session</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/type-safe-session.html">Codable Routing Session</a></li>
        </ul>
        <li class="sidebar-item collapsible">Authentication</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../authentication/authentication.html">What is Authentication?</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/typesafe-auth.html">Basic Authentication</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/jwt-auth.html">JSON Web Tokens</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/fb-google-oauth2.html">OAuth 2.0 with Facebook/Google</a></li>
        </ul>
        <li class="sidebar-item collapsible">Web Application</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../templating/templating.html">What are Web Applications?</a></li>
          <li class="nested-sidebar-item"><a href="../templating/static-file-server.html">Static File Server</a></li>
          <li class="nested-sidebar-item"><a href="../templating/stencil.html">Stencil</a></li>
          <li class="nested-sidebar-item"><a href="../templating/markdown.html">Markdown</a></li>
        </ul>
        <li class="sidebar-item collapsible">WebSockets</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../websockets/websockets.html">What are WebSockets?</a></li>
          <li class="nested-sidebar-item"><a href="../websockets/kiturawebsockets.html">Kitura WebSocket Echo Server</a></li>
        </ul>
        <li class="sidebar-item collapsible">Deploying</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../deploying/monitoring.html">Monitoring</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/ssl.html">Enabling SSL/TLS</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/docker.html">Docker</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/kubernetes.html">Kubernetes</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/cloud-foundry.html">Cloud Foundry</a></li>
        </ul>
        <li class="sidebar-item collapsible">Configuring</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../configuring/enabling-nio.html">Enabling SwiftNIO</a></li>
        </ul>
      </ul>
    </aside>
    <div id="burgerIcon" class="burger-icon" onclick="showSidebar()">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
    <div class="docs-item-2 search-container">
    </div>
    <nav class="docs-item-3 docs-nav">
      <button id="api-button" class="apiref-button" type="button" name="button" onclick="window.open('https://ibm-swift.github.io/Kitura/')">API Reference</button>
      <a class="nav-item" target="_blank" href="http://slack.kitura.io/">Need help?</a>
      <a class="nav-item" target="_blank" href="https://github.com/IBM-Swift/kitura.io/issues">Found an issue?</a>
    </nav>
    <div id="doc-container" class="docs-item-4 docs-window">
      <main>
        <h1 class="heading-1">Kitura WebSocket Echo Server</h1>
        <p class="block-text">The application we are going to create is a very simple Echo Server, this is a server that will receive a message from the client and then echo back the same message to the client, this is the simplest implementation of WebSockets.</p>
        <h2 class="heading-2"><span class="blue-text">Step 1:</span> Pre-requisites</h2>
        <p class="block-text">Before creating the server, we need to make sure everything is set up correctly, <a href="https://nodejs.org/en/" target="_blank">Node.js</a> must be installed and the project directories should be created with this terminal command:</p>
        <pre><code>mkdir EchoServer
cd EchoServer
touch Package.swift
mkdir Sources
cd Sources
mkdir ChatServer
cd ChatServer
touch ChatService.swift
touch main.swift</code></pre>
      <h2 class="heading-2"><span class="blue-text">Step 2:</span> Setting up the Server</h2>
      <p class="block-text">Add the following content to your <strong>Package.swift</strong> file:</p>
      <pre><code class="language-swift">// swift-tools-version:4.0
import PackageDescription

let package = Package(
    name: "ChatServer",
    dependencies: [
         .package(url: "https://github.com/IBM-Swift/Kitura.git", .upToNextMinor(from: "2.7.0")),
         .package(url: "https://github.com/IBM-Swift/HeliumLogger.git", from: "1.0.0"),
         .package(url: "https://github.com/IBM-Swift/Kitura-WebSocket.git", from: "2.1.2")
    ],
    targets: [
        .target(
            name: "ChatServer",
            dependencies: ["Kitura", "HeliumLogger", "Kitura-WebSocket"]),
    ]
)</code></pre>
      <div class="info">
          <p>The HeliumLogger package, while strictly not required, was added to enable logging.</p>
      </div>
      <p class="block-text">Add the following to your <strong>ChatService.swift</strong> file:</p>
      <pre><code class="language-swift">// ChatServer is a very simple chat server

import Foundation

import KituraWebSocket

class ChatService: WebSocketService {

    private var connections = [String: WebSocketConnection]()

    let connectionTimeout: Int? = 60

    public func connected(connection: WebSocketConnection) {
        connections[connection.id] = connection
    }

    public func disconnected(connection: WebSocketConnection, reason: WebSocketCloseReasonCode) {
        connections.removeValue(forKey: connection.id)
    }

    public func received(message: Data, from: WebSocketConnection) {
        from.close(reason: .invalidDataType, description: "Chat-Server only accepts text messages")

        connections.removeValue(forKey: from.id)
    }

    public func received(message: String, from: WebSocketConnection) {
        for (connectionId, connection) in connections {
            if connectionId != from.id {
                connection.send(message: message)
            }
        }
    }
}
}</code></pre>
      <p class="block-text">The class has a <strong>Dictionary</strong>, connections, which is used to keep track of the connections of all of the connected clients. The Dictionary is maintained by the connected and disconnected functions, which are, respectively, adding and removing connections from the dictionary.</p>
      <p class="block-text">The received function, which receives <strong>binary</strong> messages, is rejecting the message, closing the client connection and removing the connection from the set of known connections.</p>
      <p class="block-text">Lastly, the received function, which receives text messages, simply echoes the message received to all clients except the one who sent the message.</p>
      <p class="block-text">It should be noted that all of these functions can be invoked from many threads <strong>simultaneously</strong>. In real applications, one should add locking around the access of non-thread safe artifacts of the application such as the connections Dictionary in this very simplistic example.</p>
      <p class="block-text">Add the following to your <strong>main.swift</strong> file:</p>
      <pre><code class="language-swift">// ChatServer is a very simple chat server

import Foundation

import KituraNet
import KituraWebSocket

import HeliumLogger
import LoggerAPI

// Using an implementation for a Logger
HeliumLogger.use(.info)

WebSocket.register(service: ChatService(), onPath: "chat")

class ChatServerDelegate: ServerDelegate {
    public func handle(request: ServerRequest, response: ServerResponse) {}
}

// Add HTTP Server to listen on port 8080
let server = HTTP.createServer()
server.delegate = ChatServerDelegate()

do {
    try server.listen(on: 8080)
    ListenerGroup.waitForListeners()
} catch {
    Log.error("Error listening on port 8080: \(error).")
}
</code></pre>
      <p class="block-text">The <strong>HeliumLogger</strong> is set up to log info, warning, and error type messages.</p>
      <p class="block-text">The <strong>ChatService</strong> defined in the <strong>ChatService.swift</strong> file is registered on the path chat.</p>
      <p class="block-text">An <strong>HTTP server</strong> is created and setup to listen on port 8080.</p>
      <p class="block-text">With this server set up clients should connect to the chat service as ws://<strong>host</strong>:8080/chat, where <strong>host</strong> is the host running the server.</p>
      <h2 class="heading-2"><span class="blue-text">Step 3:</span> Setting up the Client</h2>
      <p class="block-text">The client has a simple <strong>command line interface</strong>. At startup one passes the host and port number. The client simply reads messages to be sent from the terminal and displays messages received on the terminal as well.</p>
      <p class="block-text">To create a new directory for the client, exit out of your server directory and run this terminal command:</p>
      <pre><code>mkdir EchoClient
cd EchoClient
touch package.json
touch chat.js</code></pre>
      <p class="block-text">Add the following content to your <strong>package.json</strong> file:</p>
      <pre><code class="language-json">{
  "name": "chat",
  "description": "Simple chat server client",
  "version": "0.0.1",
  "engines": {
    "node": ">=0.8.0"
  },
  "dependencies": {
    "websocket": "^1.0.23"
  }
}</code></pre>
      <p class="block-text">Then add the following contnet to your <strong>chat.js</strong> file:</p>
      <pre><code class="language-javascript">/* main file of Simple Chat Server Client */

var readline = require('readline');
var WebSocketClient = require('websocket').client

var host = process.argv[2];

rl = readline.createInterface(process.stdin, process.stdout);

rl.setPrompt('> ');
rl.prompt();
var client = new WebSocketClient();

client.on('connectFailed', function(error) {
    console.log('Connect Error: ' + error.toString());
    process.exit();
});

client.on('connect', function(connection) {
    connection.on('error', function(error) {
        console.log("Connection Error: " + error.toString());
        process.exit();
    });

    connection.on('close', function(reasonCode, description) {
        console.log('chat Connection Closed. Code=' + reasonCode + ' (' + description +')');
    });

    connection.on('message', function(message) {
        if (message.type === 'utf8') {
            console.log('\r=> ' + message.utf8Data);
            rl.prompt();
        }
    });

    rl.on('line', function(line) {
        connection.sendUTF(line);
        rl.prompt();
    });

    rl.on('close', function() {
        connection.close();
        console.log('Have a great day!');
        process.exit(0);
    });

    rl.prompt();
});
client.connect("ws://" + host +"/chat", "chat");</code></pre>
      <h2 class="heading-2"><span class="blue-text">Step 4:</span> Building and Running your server</h2>
      <p class="block-text">To build the server, go in to your server directory and run the command:</p>
      <pre><code>swift build</code></pre>
      <p class="block-text">To run the server, in the same directory, type:</p>
      <pre><code>.build/debug/ChatServer</code></pre>
      <p class="block-text">The server will now be up and running. The informational log message below will be displayed:</p>
      <pre><code>[INFO] [HTTPServer.swift:124 listen(on:)] Listening on port 8080</code></pre>
      <h2 class="heading-2"><span class="blue-text">Step 5:</span> Setting up and Running the client</h2>
      <p class="block-text">To setup the client, go in to your client directory and run the terminal command:</p>
      <pre><code>npm install</code></pre>
      <div class="info">
          <p>That will install the websocket package.</p>
      </div>
      <p class="block-text">To run the client,in the same directory run the terminal command:</p>
      <pre><code>node chat.js host:8080</code></pre>
      <p class="block-text">Where <strong>host</strong> is the hostname of the host on which the server is running, e.g. if your server is running on the <strong>localhost</strong> run:</p>
      <pre><code>node chat.js localhost:8080</code></pre>
      <p class="block-text">As described above, the server echoes all text messages sent to it to all of the clients that have connected to it, with the exception of the client that sent the message. Therefore, in order to see the example in action you will need to connect more than one client to the server. The client can be run in several terminal windows on the same computer. You can then enter a message on one client and see it appear on another client and vice versa.</p>
      </main>
    </div>
    <div id="top-page" class="top-page">
      <a href="#">Back to top</a>
    </div>
  </section>
  <script type="text/javascript" src="../../scripts/learn.js"></script>
  <script src="../../scripts/prism.js"></script>
</body>
</html>
